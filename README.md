# Koishi_Comfyui_Quiet
---

# Koishi ComfyUI 鹿鸣画图插件

这是一个 Koishi 插件，它允许您的 Koishi 机器人与 ComfyUI 服务器无缝集成，用户可以通过简单的聊天指令触发 ComfyUI 生成高质量的图片。

## ✨ 主要功能

*   **智能触发**: 通过自定义前缀（如“鹿鸣”、“lumi”）在聊天中直接触发图片生成。
*   **尺寸控制**: 支持在描述中指定图片尺寸，如“横屏”、“竖屏”或“正方形”。
*   **动态注入**: 自动将用户输入的提示词、随机种子和指定分辨率注入到 ComfyUI 工作流中。
*   **实时反馈**: 任务提交后提供即时反馈，并在图片生成完成后自动发送。
*   **高度可配置**: 灵活配置 ComfyUI 服务器地址、工作流路径、触发前缀和分辨率等。

## 🚀 安装

 **Koishi 控制台安装 (推荐)**:
    *   进入您的 Koishi 控制台。
    *   导航到“插件市场”。
    *   搜索 `comfyui-lumi` 并点击安装。
    *   安装完成后，在“已安装插件”中找到 `comfyui-lumi` 并启用。

## 💡 最重要的使用方法

本插件的核心在于通过聊天指令触发 ComfyUI 进行图片生成。

### 1. 触发图片生成

用户只需在聊天消息的开头输入预设的**触发前缀**，然后紧跟您想要生成的图片描述。

*   **默认触发前缀**: `鹿鸣`, `lumi`, `Lumi` (这些可以在插件配置中修改)。

**示例**:

*   `鹿鸣 一只可爱的猫咪在阳光下打盹`
*   `lumi 赛博朋克风格的城市夜景`
*   `Lumi 穿着宇航服的柴犬`

### 2. 指定图片尺寸

您可以在图片描述中加入特定的关键词来控制生成图片的尺寸。插件会根据这些关键词自动调整 ComfyUI 工作流中的分辨率设置。

*   **关键词**: `横屏`, `竖屏`, `正方形`

**示例**:

*   `鹿鸣 一只狗在草地上奔跑 横屏` (生成一张横向的图片)
*   `lumi 一座宏伟的城堡 正方形` (生成一张正方形的图片)
*   `Lumi 一个小女孩在花海中 竖屏` (生成一张纵向的图片)

**注意**: 如果未指定尺寸关键词，插件将使用配置中的**默认分辨率**。

### 3. 获取帮助信息

如果您不确定如何使用，或者想查看当前支持的触发前缀和使用示例，可以在聊天中发送指令：

*   发送 `lumi`
*   发送 `鹿鸣`

机器人会回复详细的帮助信息，包括如何触发和尺寸控制的说明。

**完整使用流程**:

1.  用户发送一条包含触发前缀和描述的消息（可选包含尺寸关键词）。
2.  机器人回复“正在为您生成图片，请稍候...”。
3.  插件将处理后的提示词和分辨率发送给 ComfyUI 服务器。
4.  插件持续轮询 ComfyUI 任务状态。
5.  ComfyUI 完成图片生成后，插件会将生成的图片发送回聊天。

## ⚙️ 插件配置详解

在 Koishi 控制台的 `comfyui-lumi` 插件设置页面，您可以对插件进行详细配置。

### 核心配置

*   **ComfyUI 服务器地址 (comfyuiServer)**
    *   **类型**: 字符串
    *   **默认值**: `http://127.0.0.1:8189`
    *   **说明**: 您的 ComfyUI 服务器的 HTTP 地址。请确保 Koishi 机器人可以访问到此地址。例如：`http://127.0.0.1:8189` 或 `http://your_comfyui_ip:port`。

*   **工作流 JSON 文件路径 (workflowPath)**
    *   **类型**: 字符串
    *   **默认值**: `Lumi_Chatglm_1155.json`
    *   **说明**: ComfyUI 工作流 JSON 文件的路径。
        *   **相对路径**: 如果您提供的是相对路径（如默认值），它将相对于插件的 `src` 目录进行解析。这意味着 `Lumi_Chatglm_1155.json` 文件应该放在插件的 `src` 目录下。
        *   **绝对路径**: 您也可以提供一个完整的绝对路径，例如 `/path/to/your/workflow.json`。
    *   **重要**: 请确保此 JSON 文件是有效的 ComfyUI 工作流，并且包含以下关键节点，以便插件能够正确注入提示词、随机种子和分辨率：
        *   **提示词节点**: 插件默认查找节点 `1` 的 `inputs.input_string` 字段来注入用户提示词。
        *   **分辨率节点**: 插件默认查找节点 `2` 的 `inputs.width` 和 `inputs.height` 字段来设置图片分辨率。
        *   **随机种子节点**: 插件默认查找节点 `3` 的 `inputs.seed` 字段来设置随机种子。
        *   如果您的工作流节点 ID 不同，插件可能无法正常工作，需要您调整工作流以匹配或修改插件代码。

*   **触发前缀列表 (triggerPrefixes)**
    *   **类型**: 字符串数组
    *   **默认值**: `['鹿鸣', 'lumi', 'Lumi']`
    *   **说明**: 用户消息以这些前缀开头时，将触发 ComfyUI 生成图片。您可以添加或删除前缀，例如添加 `['画图', '生成']`。

### 性能与超时配置

*   **轮询间隔 (pollInterval)**
    *   **类型**: 数字 (毫秒)
    *   **默认值**: `1000` (1 秒)
    *   **范围**: `500` - `10000`
    *   **说明**: 插件轮询 ComfyUI 任务状态的间隔时间。较小的值可以更快地获取结果，但会增加服务器负载。

*   **轮询超时 (pollTimeout)**
    *   **类型**: 数字 (毫秒)
    *   **默认值**: `60000` (60 秒)
    *   **范围**: `10000` - `300000`
    *   **说明**: 等待 ComfyUI 任务完成的最大超时时间。如果在此时间内未完成，任务将被视为失败。对于生成复杂图片，可能需要适当增加此值。

### 分辨率配置

这些配置项允许您自定义不同尺寸模式下生成的图片分辨率。

*   **默认图片宽度 (defaultWidth)**
    *   **类型**: 数字
    *   **默认值**: `896`
    *   **说明**: 当用户未指定“横屏”、“竖屏”或“正方形”时，图片使用的默认宽度。

*   **默认图片高度 (defaultHeight)**
    *   **类型**: 数字
    *   **默认值**: `1600`
    *   **说明**: 当用户未指定“横屏”、“竖屏”或“正方形”时，图片使用的默认高度。

*   **横屏模式宽度 (landscapeWidth)**
    *   **类型**: 数字
    *   **默认值**: `1280`
    *   **说明**: 用户指定“横屏”时，图片使用的宽度。

*   **横屏模式高度 (landscapeHeight)**
    *   **类型**: 数字
    *   **默认值**: `720`
    *   **说明**: 用户指定“横屏”时，图片使用的高度。

*   **正方形模式边长 (squareSize)**
    *   **类型**: 数字
    *   **默认值**: `1024`
    *   **说明**: 用户指定“正方形”时，图片使用的边长（宽度和高度相同）。

*   **竖屏模式宽度 (portraitWidth)**
    *   **类型**: 数字
    *   **默认值**: `896`
    *   **说明**: 用户指定“竖屏”时，图片使用的宽度。

*   **竖屏模式高度 (portraitHeight)**
    *   **类型**: 数字
    *   **默认值**: `1600`
    *   **说明**: 用户指定“竖屏”时，图片使用的高度。

## ⚠️ 注意事项与故障排除

*   **ComfyUI 服务器状态**: 确保您的 ComfyUI 服务器正在运行，并且可以通过 `comfyuiServer` 配置的地址从 Koishi 机器人所在的网络访问。
*   **工作流文件**: 仔细检查 `workflowPath` 配置是否正确，确保 JSON 文件存在且可读。如果工作流文件加载失败，插件将无法工作。
*   **工作流结构**: 插件依赖于 ComfyUI 工作流中特定节点（如节点 `1`、`2`、`3`）的 `inputs` 字段来注入数据。如果您使用了自定义的工作流，请确保其结构与插件预期的一致，否则可能无法正确替换提示词、分辨率或种子。
*   **生成时间**: 图片生成可能需要较长时间，特别是对于复杂的模型或高分辨率图片。请耐心等待，或适当调整 `pollTimeout`。
*   **日志查看**: 如果遇到问题，请查看 Koishi 控制台的日志输出，以及 ComfyUI 服务器的日志，它们通常会提供有用的错误信息。

---
